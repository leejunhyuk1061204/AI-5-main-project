# 시스템 구조 및 데이터 흐름 설계

본 문서는 차량에서 발생하는 데이터를 수집하고 AI가 분석하여 정비 리포트를 제공하는 전체 흐름을 정의합니다.

---

## 1. 기술 스택 (Tech Stack)

| 영역 (Domain) | 핵심 기술 (Core Technologies) | 설명 |
|:---:|:---|:---|
| **Mobile App** | **React Native** | Android/iOS 크로스 플랫폼 애플리케이션 |
| **Backend** | **Spring Boot (Java), FastAPI (Python)** | 비즈니스 로직 및 AI 모델 서빙 |
| **Infra & DB** | **PostgreSQL (+TimescaleDB, pgvector), RabbitMQ, Docker** | 데이터 저장, 비동기 메시징, 컨테이너 환경 |
| **AI / ML** | **PyTorch, YOLOv8, LSTM, XGBoost** | 시계열 분석(고장 예측) 및 이미지 진단 |
| **Device** | **OBD-II (ELM327)** | 차량 데이터 실시간 통신 인터페이스 |

---

## 2. 시스템 구조 개요 (Architecture Overview)

전체 시스템은 **Client Layer, Server Layer, AI Layer**의 3가지 핵심 계층으로 구성됩니다.

```mermaid
graph TD
    classDef client fill:#e1f5fe,stroke:#01579b,stroke-width:1px;
    classDef server fill:#fff3e0,stroke:#e65100,stroke-width:1px;
    classDef storage fill:#e8f5e9,stroke:#1b5e20,stroke-width:1px;
    classDef ai fill:#f3e5f5,stroke:#4a148c,stroke-width:1px;

    subgraph Client_Layer ["Client Layer (모바일 앱)"]
        direction TB
        OBD[OBD-II 동글]
        App[모바일 앱]
        OBD <--> App
    end

    subgraph Server_Layer ["Server Layer (백엔드)"]
        direction TB
        MainBE[메인 서버]
        MQ[메시지 큐]
        MainBE --- MQ
    end

    subgraph Storage_Layer ["Storage Layer (저장소)"]
        direction TB
        DB[통합 데이터베이스]
        S3[파일 저장소]
    end

    subgraph AI_Layer ["AI Layer (분석 엔진)"]
        direction TB
        Analysis[AI 분석 서버]
        LLM[리포트 생성 모델]
    end

    %% 연결 관계
    App --> |주행 데이터 전송| MainBE
    MainBE <--> Storage_Layer
    MQ --> |분석 작업 요청| AI_Layer
    AI_Layer --> |분석 결과 전달| MainBE
    MainBE <--> HM[제조사 클라우드]

```

---

## 3. 계층별 역할 (Component Specification)

### 3.1 Client Layer (모바일 앱)
- **데이터 수집**: 주행 중 발생하는 차량 데이터를 실시간으로 기록합니다.
- **음성 안내 (TTS)**: 차량 고장 코드(DTC)가 나타나면 즉시 음성으로 알려줍니다.
- **연결 복구 전송**: 인터넷이 끊기면 데이터를 앱에 임시 저장했다가, 다시 연결될 때 서버로 보냅니다.

### 3.2 Server Layer (메인 백엔드)
- **정보 관리**: 사용자 계정, 차량 등록 정보, 주행 기록을 통합 관리합니다.
- **작업 조율**: AI 분석이나 외부 데이터 동기화처럼 시간이 걸리는 일을 조율하고 관리합니다.

### 3.3 AI Layer (분석 엔진)
- **이상 탐지**: 평소와 다른 미세한 고장 징후를 찾아냅니다.
- **DTC 즉시 분석**: 감지된 고장 코드를 **RAG(검색 증강 생성)**를 통해 실시간으로 해석하여 안내합니다.
- **복합 진단**: 숫자 데이터뿐만 아니라 사진이나 엔진 소리를 함께 분석하여 더 정확한 결과를 냅니다.
- **리포트 작성**: 분석 결과를 일반 운전자가 이해하기 쉬운 보고서로 정리합니다.

### 3.4 Storage Layer (데이터 저장)
- **통합 DB**: 차량과 관련된 모든 정보 및 주행 기록을 한곳에 저장합니다.
- **중요 데이터 보관**: 일반적인 기록은 주기에 맞춰 정리하고, 사고나 고장 의심 구간의 상세 데이터는 별도 보관소(S3)에 영구 저장합니다.

---

## 4. 주요 데이터 흐름 (System Data Flow)

### 4.1 주행 데이터 수집 및 전송
```mermaid
sequenceDiagram
    autonumber
    participant Car as 차량 (OBD)
    participant App as 모바일 앱
    participant Server as 메인 서버
    participant AI as AI Layer (RAG)

    Note over Car, App: [1단계] 데이터 기록
    App->>Car: 주행 정보 요청
    Car-->>App: 실시간 데이터 반환
    Note right of App: 앱 내부에 암호화하여 임시 저장
    
    opt 고장 코드(DTC) 감지 시
        App->>Server: 고장 코드 즉시 전송
        Server->>AI: RAG 조회 (원인 및 대응 방법 확인)
        AI-->>Server: 알기 쉬운 설명 반환
        Server-->>App: 진단 결과 및 가이드 전달
        App->>App: TTS 음성 안내 및 알림 생성 (RAG 기반)
    end

    Note over App, Server: [2단계] 서버 업로드 (정기 또는 주행 종료 후)
    loop 배차 전송
        App->>Server: 모아둔 주행 데이터 전송 (Batch)
        Server->>Server: 데이터 검험 및 저장
        Server-->>App: 전송 성공 확인 (ACK)
        Note right of App: 전송 성공 시 로컬 버퍼 비움
    end
```

### 4.2 AI 정밀 진단 프로세스 (Guided Diagnosis)
```mermaid
sequenceDiagram
    autonumber
    actor Driver as 운전자
    participant App as 모바일 앱
    participant Server as 메인 서버
    participant AI as AI 엔진

    Driver->>App: 정밀 진단 요청 (사진/음성 포함)
    App->>Server: 진단 데이터 업로드
    Server->>AI: 분석 요청
    
    alt 정보가 더 필요할 때
        AI-->>Server: 추가 증거 요청 (예: 부위별 촬영)
        Server-->>App: 사용자에게 행동 가이드 알림
        Driver->>App: 추가 사진/음성 업로드
        App->>Server: 보충 데이터 전달
        Server->>AI: 최종 분석 요청
    end

    AI->>AI: 최종 분석 및 리포트 작성
    AI-->>Server: 진단 결과 반환
    Server-->>App: 정비 리포트 화면 표시
```

---

## 5. 보안 및 시스템 안정성 (Security & Reliability)

- **데이터 보안**: 차량 번호 등 중요한 정보는 암호화하여 저장하며, 모든 데이터 전송은 보안 통로를 통과합니다.
- **네트워크 불안정 시 데이터 보호**: 인터넷 연결이 원활하지 않은 환경에서도 주행 데이터가 기록되고, 복구 시 안전하게 전송되도록 설계되었습니다.
- **분리 처리**: 시간이 오래 걸리는 무거운 분석 작업은 서비스 속도에 영향을 주지 않도록 분리하여 처리합니다.

---
**[설계 문서 종료]**
