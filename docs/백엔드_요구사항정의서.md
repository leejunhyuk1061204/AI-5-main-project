# 백엔드 요구사항정의서 (Backend-Centric)

> **버전**: v1.0
> **작 작성일**: 2026-01-14
> **대상**: 백엔드 개발 및 시스템 아키텍처 설계

---

## 1. 개요 및 시스템 목적
플랫폼의 중추 역할을 수행하며, OBD-II 데이터 수집/가공, 제조사 클라우드 연동, AI 진단 모델 인터페이스 및 대용량 데이터 전송 효율화를 담당함.

### 1.1 핵심 백엔드 기술 스택
- **Language/Framework**: Java 17, Spring Boot 3.x
- **Database**: 
  - **PostgreSQL**: 사용자 정보, 차량 정보, 정비 이력, 토큰 관리 (관계형 데이터)
  - **TimescaleDB**: OBD 시계열 로그 데이터 (1Hz 수집/3분 배치, 3day retention)
- **Queue**: RabbitMQ (AI 비동기 진단 요청)
- **Auth**: JWT (Stateless Authentication)

---

## 2. 백엔드 기능 세부 명세 (Backend Checklist)

#### 2.1 사용자 인증 및 계정 (Auth & User)
- [x] **BE-AU-001** [C] 회원가입: 패스워드 정책 검증 및 BCrypt 암호화 저장
- [x] **BE-AU-002** [R] 로그인: JWT 발급 및 Payload 설계
- [x] **BE-AU-003** [R] 내 정보 조회: 토큰 기반 프로필 및 알림 설정 반환
- [x] **BE-AU-004** [U] 정보 수정: 닉네임 유효성 검사 및 프로필 이미지 업데이트
- [ ] **BE-AU-005** [U] 비밀번호 찾기: 이메일 인증 기반 재설정 Flow
- [x] **BE-AU-006** [U] 토큰 갱신: Refresh Token Rotation 정책 적용
- [x] **BE-AU-007** [D] 회원 탈퇴: Soft Delete 및 데이터 익명화
- [x] **BE-AU-008** [P] 보안 필터: Spring Security 기반 권한 분리 및 JWT 필터

#### 2.2 차량 및 자산 관리 (Vehicle & Master)
- [x] **BE-VH-001** [C] 차량 수동 등록: 마스터 데이터 검증 및 소유 관계 저장
- [x] **BE-VH-002** [C] 차량 자동 등록: OBD 수집 VIN 기반 자동 매핑 등록
- [x] **BE-VH-003** [R] 마스터 데이터 조회: 제조사/모델/연식 트리 데이터 제공
- [x] **BE-VH-004** [R] 차량 목록 조회: 사용자 소유 차량 및 요약 정보 반환
- [ ] **BE-VH-005** [R] 차량 제원 동기화: 공공 API 연동을 통한 상세 스펙 업데이트
- [x] **BE-VH-006** [U] 대표 차량 전환: 비즈니스 로직 기반 Primary 차량 변경
- [x] **BE-VH-007** [D] 차량 삭제: 관련 데이터 보존을 위한 소프트 딜리트 처리

#### 2.3 텔레메트리 파이프라인 (Drive & Telemetry)
- [x] **BE-TD-001** [C] 주행 세션 개시: Trip ID 발급 및 초기 상태 기록
- [x] **BE-TD-002** [C] 벌크 로그 수집: 3분 단위 로그 무결성 검증 및 적재
- [x] **BE-TD-003** [P] 로그 전처리: 이상 수치(노이즈) 필터링 및 컬럼 파싱
- [x] **BE-TD-004** [C] 주행 요약 엔진: 주행 종료 시 통계 및 운전 점수 산출
- [x] **BE-TD-005** [R] 주행 기록 조회: 리스트 및 상세 경로/통계 정보 제공
- [ ] **BE-TD-006** [D] 데이터 리텐션: [Batch] 3일 경과 데이터 자동 삭제 프로세스
- [ ] **BE-TD-007** [R] 주간/월간 리포트: 주행 패턴 분석 통계 데이터 가공

#### 2.4 AI 진단 및 서비스 (AI & Cloud)
- [ ] **BE-AI-001** [C] 진단 세션 관리: 진단 ID 발급 및 멀티모달 환경(텍스트/오디오/이미지) 상태 관리
- [ ] **BE-AI-002** [C] DTC 이력 저장: OBD에서 수신된 고장 코드 및 스냅샷(Freeze Frame) DB 적재
- [ ] **BE-AI-003** [P] 미디어 업로드: S3 Presigned URL 발급 및 이미지/오디오 파일 처리
- [ ] **BE-AI-004** [P] 이벤트 트리거 & 큐잉:
    - RabbitMQ 기반 비동기 분석 요청
    - **[Trigger]** 새로운 DTC 감지 시 자동으로 '고장 분석' 이벤트 발행
    - **[Trigger]** 사용자 수동 진단 요청 처리
- [ ] **BE-AI-005** [R] RAG 엔진 연동 (Internal):
    - 매뉴얼/정비 지식 베이스 벡터 검색 서비스 구현 (PGVector)
    - 진단 결과에 RAG 검색 결과(참고 문서 출처) 매핑
- [ ] **BE-AI-006** [R] 진단 리포트 조회: 최종 AI 분석문 + 관련 지식 + 추천 정비소 제공
- [ ] **BE-AI-007** [U] 멀티턴 대화 처리: AI 보충 질문에 대한 사용자 답변 처리 및 문맥 유지
- [x] **BE-CL-001** [R] 클라우드 연동: OAuth 2.0 Flow 및 제조사 API 인증
- [x] **BE-CL-002** [U] 토큰 암호화 관리: AES-256 저장 및 리프레시 로직
- [ ] **BE-CL-003** [P] 클라우드 동기화: [Batch] 주기적 데이터 동기화 워커

#### 2.5 소모품 및 알림 (Maintenance & Notification)
- [x] **BE-MT-001** [C] 정비 이력 등록: 수동 입력 기반 기록 및 수명 리셋
- [x] **BE-MT-002** [R] 잔존 수명 조회: AI 예측값 기반 소모품 상태 반환
- [ ] **BE-NT-001** [R] 통합 이동함: 알림 내역 조회 및 상태 관리
- [ ] **BE-NT-002** [P] 알림 발송 엔진: FCM 기반 푸시 전송 및 재시도 로직

#### 2.6 시스템 관리 및 기타 (System & Admin) - 5 Tasks
| ID | 구분 | 기능명 | 상세 백엔드 로직 | 우선순위 |
|:---|:---:|:---|:---|:---:|
| BE-SY-001 | **R** | 헬스 체크 API | 서버 상태 및 DB/메시지큐 연결성 모니터링용 엔드포인트 | 🔴 |
| BE-SY-002 | **C** | 시연 데이터 주입 | 테스트 및 시연을 위한 가상 차량/주행 로그 생성 스크립트 | 🔴 |
| BE-SY-003 | **P** | 에러 로깅/추적 | Uncaught Exception 핸들링 및 로그 파일(logs/) 관리 | 🔴 |
| BE-SY-004 | **P** | CORS/Rate Limit | 보안을 위한 도메인 제한 및 API 호출 횟수 제한 설정 | 🟡 |
| BE-SY-005 | **D** | 임시 파일 정리 | [Batch] S3로 이관 완료된 서버 내 임시 미디어 파일 물리적 삭제 | 🟡 |

---

## 3. 백엔드 비기능 요구사항 (BE-NFR)

### 3.1 성능 및 데이터 관리
- **NFR-PERF-001**: API 응답 속도 평균 200ms 미만 (AI 모델 연동 제외).
- **NFR-PERF-002**: TimescaleDB의 **Retention Policy** 적용 (3일 경과 데이터 자동 드랍).
- **NFR-PERF-003**: 3분 배치 업로드 시 **Bulk Insert**를 통한 DB I/O 최적화.

### 3.2 보안 및 규제 준수
- **NFR-SEC-001**: 전 구간 HTTPS(TLS 1.2+) 적용.
- **NFR-SEC-002**: 개인정보(이메일, 차대번호 등) DB 저장 시 암호화 적용 검토.
- **NFR-SEC-003**: API 호출 시 **CORS 설정** 및 **Rate Limiting** 적용.

---

## 4. 데이터 유지보수 정책
1. **Raw Log (Hot)**: `obd_logs` - 3일 보관 후 요약 데이터 생성 시 삭제.
2. **Trip Summary (Warm)**: 주행 기록 - 서비스 운영 기간 내 영구 보존.
3. **Audit Log**: 시스템 접속 및 주요 변경 이력 보관.
