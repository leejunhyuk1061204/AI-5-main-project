# 소모품 다중 등록 및 교체 정보 추론 구현 계획

차량 수동 등록 시 사용자가 여러 소모품의 교체 이력을 한 번에 입력할 수 있도록 기능을 확장하고, 입력되지 않은 항목에 대해 표준 주기를 바탕으로 상태를 추론하는 로직을 추가합니다.

## 제안 사항 및 확인 요청

> [!IMPORTANT]
> **통합 피처 및 하이브리드 AI 모델 전략 (Unified & Hybrid AI)**
> 1. **Phase 1: (수식) 즉시 초기화**: 등록 시점 Zero-Cold Start 방지를 위한 Heuristic 초기화.
> 2. **Phase 2: (AI) 마모도/수명 이원 분석**: 
>    - **마모 가중치 (Wear Factor)**: LSTM이 운전 습관(가감속, 부하 등)을 분석하여 부품별 소모 속도(배율) 산출.
>    - **잔존 수명 (Remaining Life)**: (기준 주기 / 마모 가중치) - 주행거리 공식을 통해 최종 % 산출.
> 3. **데이터 정합성**: HM(클라우드) 데이터 수신 시 초기값 즉시 교정 및 AI 모델 성능 고도화.

### 등록 대상 소모품 목록 (마스터 데이터 기준)
- 현재 소모품 마스터 테이블(`consumable_items`)에 등록된 전 품목을 대상으로 하며, 항목의 추가/삭제에 유연하게 대응합니다. (현재 9종 등록됨: 엔진오일, 타이어, 브레이크 패드, 브레이크 오일, 냉각수, 에어컨 필터, 와이퍼, 배터리, 미션 오일)

---

## AI 모델 및 데이터 연동 (Task 3 & 4)

### 1. AI 학습을 위한 핵심 OBD 데이터 항목 (제안)
LSTM 및 XGBoost의 정밀도를 위해 다음 항목을 `obd_logs` 테이블에 추가/보완할 것을 권장합니다:
- **누적 주행거리 (`odometer`)**: AI가 소모품 상태를 판단하는 절대적 기준.
- **외기 온도 (`ambient_temp`)**: 배터리 성능 및 냉각수 마모도 예측에 필수.
- **연료 잔량 (`fuel_level`)**: 연료 필터 및 주행 패턴 분석에 활용.
- **DTC 개수 (`dtc_count`)**: 차량의 전반적인 이상 징후 지표.
- *기존 항목(RPM, 속도, 전압, 부하 등)은 유지.*

> [!NOTE]
> **테이블 수정 제안**: `obd_logs` 테이블에 위 3가지 컬럼(`odometer`, `ambient_temp`, `fuel_level`) 추가 필요.

### 2. 차량 식별 로직 (Task 4)
들어오는 OBD 데이터가 어느 차량인지 식별하는 가장 정석적인 방법은 다음과 같습니다:
- **OBD 기기 식별자(`obd_device_id`) 활용**: 
  - 앱이나 OBD 장치가 서버로 데이터를 보낼 때 헤더 혹은 본문에 `obd_device_id`를 포함.
  - 백엔드는 `vehicles` 테이블에서 해당 `obd_device_id`에 매핑된 `vehicle_id`를 찾아 데이터를 저장.
  - 이 방식은 `vehicle_id`를 노출하지 않아도 되므로 보안상 유리함.

## Proposed Changes

### [Backend] DTO 및 서비스

#### [MODIFY] VehicleDto.java
- `RegistrationRequest` 클래스 내부에 `List<ConsumableRegistrationRequest> consumables` 필드 추가.
- `ConsumableRegistrationRequest` 내부 클래스 정의:
  - `code` (필수), `lastReplacedAt` (선택), `lastReplacedMileage` (선택)

#### [MODIFY] VehicleService.java
- `registerVehicle` 메소드 수정: 차량 저장 후 요청된 소모품 정보를 바탕으로 `VehicleConsumable` 엔티티 생성 및 저장.
- 추론 로직 서비스 적용.

## Frontend Integration Info

- **소모품 선택**: `GET /api/v1/master/consumables` 요청을 통해 시스템에 등록된 소모품 마스터 목록을 가져와 동적으로 표시합니다.
- **다중 등록 UI**: "+ 추가" 버튼을 통해 새로운 행을 생성하고, 각 행에서 소모품 종류(드롭다운)와 교체 이력(날짜/거리)을 입력받습니다.

---

## Verification Plan

### Manual Verification
1. **Insomnia를 이용한 시나리오 기반 테스트**
   - **Case 1**: 날짜/거리 모두 입력 (정상 등록 확인)
   - **Case 2**: 거리만 입력 (날짜가 오늘 혹은 역산된 값으로 들어가는지 확인)
   - **Case 3**: 모두 미입력 (표준 주기에 따라 추론된 값이 들어가는지 확인)
2. **로그 확인**
   - `VehicleService`에서 소모품 등록 및 추론 과정이 `log.info`로 상세히 남는지 확인.
