# =========================================================================
# ğŸš€ AI-5 Car-Sentry ì›í´ë¦­ ì¸í”„ë¼ ì„œë¹„ìŠ¤
# =========================================================================
# ğŸ’¡ [í•„ë…] RabbitMQ ì—ëŸ¬ ì‹œ ì¡°ì¹˜ë°©ë²• (PRECONDITION_FAILED)
#
# í ì„¤ì •ì´ ë³€ê²½ë˜ì–´ ê¸°ì¡´ íì™€ ì¶©ëŒì´ ë°œìƒí•  ê²½ìš°, ì•„ë˜ ëª…ë ¹ì–´ë¡œ íë¥¼ ì‚­ì œí•˜ê³  ì¬ì‹¤í–‰í•˜ì„¸ìš”.
# docker exec car-sentry-mq rabbitmqctl delete_queue ai.diagnosis.queue
#
# (ê¸°ë³¸ ì‹¤í–‰: docker-compose up -d)
# =========================================================================

services:
  # 1. ë°ì´í„°ë² ì´ìŠ¤ (PostgreSQL + TimescaleDB + pgvector)
  db:
    image: timescale/timescaledb-ha:pg15
    container_name: car-sentry-db
    restart: always
    environment:
      - POSTGRES_USER=${DB_USER:-postgres}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-postgres}
      - POSTGRES_DB=${DB_NAME:-car_sentry}
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - ./data/postgres_1024:/var/lib/postgresql/data
      - ./db/schema.sql:/docker-entrypoint-initdb.d/01_schema.sql
      - ./db/data.sql:/docker-entrypoint-initdb.d/02_data.sql
      - ./db/seed_car_models.sql:/docker-entrypoint-initdb.d/03_seed_car_models.sql
    networks:
      - car-sentry-network

  # 2. ë©”ì‹œì§€ í (RabbitMQ)
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: car-sentry-mq
    restart: always
    environment:
      - RABBITMQ_DEFAULT_USER=${MQ_USER:-guest}
      - RABBITMQ_DEFAULT_PASS=${MQ_PASSWORD:-guest}
    ports:
      - "${MQ_PORT:-5672}:5672" # AMQP í¬íŠ¸
      - "${MQ_MANAGEMENT_PORT:-15672}:15672" # Management UI í¬íŠ¸
    networks:
      - car-sentry-network

networks:
  car-sentry-network:
    driver: bridge

volumes:
  postgres_data:
