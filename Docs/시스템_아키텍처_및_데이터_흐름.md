# ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë° ë°ì´í„° íë¦„ ìƒì„¸ ì„¤ê³„ì„œ

> **ë¬¸ì„œ ë²„ì „**: v1.0
> **ê¸°ë°˜ ë¬¸ì„œ**: ê¸°ìˆ  êµ¬í˜„ ê°€ì´ë“œë¼ì¸
> **ì‘ì„±ì¼**: 2026-01-10

---

## 1. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ì˜¤ë²„ë·° (System Overview)

ë³¸ ì‹œìŠ¤í…œì€ **ì‹¤ì‹œê°„ì„±(Real-time)**ì´ ìš”êµ¬ë˜ëŠ” OBD-II ì°¨ëŸ‰ ë°ì´í„° ì²˜ë¦¬ì™€ **ê³ ì—°ì‚°(High-Compute)**ì´ í•„ìš”í•œ AI/LLM ì§„ë‹¨ì„ ë™ì‹œì— ìˆ˜í–‰í•˜ëŠ” í•˜ì´ë¸Œë¦¬ë“œ ì•„í‚¤í…ì²˜ë¥¼ ì±„íƒí•©ë‹ˆë‹¤.

### 1.1 High-Level Architecture Diagram

```mermaid
graph TD
    %% Client Layer (Top)
    subgraph Client_Layer["Client Layer"]
        direction TB
        OBD_Adapter[("OBD-II Adapter")]
        MobileApp[("Mobile App")]
        OBD_Adapter <== "Bluetooth" ==> MobileApp
    end

    %% Backend Layer (Center Hub)
    subgraph Backend_Layer["Backend Layer"]
        direction TB
        Gateway["Main Backend<br/>(Java Spring Boot)"]
        MQ["Message Queue<br/>(RabbitMQ)"]
        Gateway -- "Publish Task" --> MQ
    end

    %% Layer Connections (ì„œë¸Œê·¸ë˜í”„ ë°–ìœ¼ë¡œ ì´ë™)
    MobileApp -- "REST/WebSocket" --> Gateway

    %% Data Layer
    subgraph Data_Layer["Data Persistence Layer"]
        direction TB
        subgraph Postgres_Integrated["PostgreSQL Integrated"]
            direction TB
            RDB[("Relational DB")]
            TSDB[("Time-series DB")]
            VDB[("Vector DB")]
        end
        S3_Bucket[("AWS S3 Bucket")]
    end
    Gateway -- "Business CRUD" --> RDB
    Gateway -- "Telemetry Write" --> TSDB
    Gateway -- "Similarity Search" --> VDB
    Gateway -- "File I/O" --> S3_Bucket

    %% External & AI (Narrow Layout)
    subgraph External_Services["External Interfaces"]
        direction TB
        CloudAPI["Manufacturer API"]
        SearchAPI["Web Search API"]
        PushSvc["FCM (Push Notification)"]
    end
    
    MQ -- "Sync Task" --> CloudAPI
    MQ -- "Notify Task" --> PushSvc

    subgraph AI_Systems["AI Systems"]
        direction TB
        Orchestrator["AI Service<br/>(FastAPI)"]
        LLM_Agent["LLM Synthesis"]
    end

    MQ -- "Subscribe & Process" --> Orchestrator
    Orchestrator -- "Media Fetch / Training" --> S3_Bucket
    Orchestrator -- "Update Result" --> Gateway
    Gateway -- "Prompt & Context" --> LLM_Agent
    LLM_Agent -- "External Search" --> SearchAPI
```

---

## 2. ìƒì„¸ ì»´í¬ë„ŒíŠ¸ ëª…ì„¸ (Detailed Component Specification)

### 2.1 Client Layer (Mobile/Web)
- **Role**: ë°ì´í„° ìˆ˜ì§‘ì˜ ìµœì „ì„ ì´ì ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤.
- **Key Modules**:
    - **OBD Connector**: ELM327ê³¼ì˜ ë¸”ë£¨íˆ¬ìŠ¤ ì†Œì¼“ í†µì‹  ê´€ë¦¬. `AT Command` ì „ì†¡ ë° ì‘ë‹µ íŒŒì‹±. (Connection Keep-alive í•„ìˆ˜)
    - **Buffer Manager**: 1Hz ì£¼ê¸°ì˜ ê³ ë¹ˆë„ ë°ì´í„°ë¥¼ ë¡œì»¬ ë²„í¼ì— ì„ì‹œ ì €ì¥ í›„, ë„¤íŠ¸ì›Œí¬ ìƒíƒœì— ë”°ë¼ ë°°ì¹˜(Batch) ì „ì†¡ ë˜ëŠ” ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°.
    - **Local Lite-AI**: ë„¤íŠ¸ì›Œí¬ ë‹¨ì ˆ ì‹œ(Tunnel ë“±) ê¸°ë³¸ì ì¸ ì•ˆì „ ê²½ê³ (ê¸‰ë°œì§„, ê³¼ì—´)ë¥¼ ìˆ˜í–‰í•˜ëŠ” ê²½ëŸ‰í™”ëœ Rule-based ë¡œì§ ë‚´ì¥.

### 2.2 Backend Layer (Java Spring Boot)
- **Role**: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬, ì‚¬ìš©ì ì¸ì¦, ë°ì´í„° ì˜ì†í™”, AI/ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™ì˜ ì¤‘ì¶”.
- **Function**: ëª¨ë“  ìš”ì²­ì˜ ì§„ì…ì (API Gateway)ì´ë©°, ì‹¤ì‹œê°„ Telemetry ë°ì´í„°ë¥¼ íŒŒì‹±í•˜ì—¬ DBì— ì ì¬í•©ë‹ˆë‹¤. 
- **Message Broker (RabbitMQ) í™œìš© ë²”ìœ„**:
    - **AI Task**: ì‹œê°„ì´ ì†Œìš”ë˜ëŠ” AI ì§„ë‹¨ ë° ì¶”ë¡  ì‘ì—… ë¶„ì‚° ì²˜ë¦¬.
    - **Push Notification**: FCMì„ í†µí•œ ëŒ€ëŸ‰ ì•Œë¦¼ ë°œì†¡ ì‹œ ì‘ë‹µ ì§€ì—° ë°©ì§€ ë° ì¬ì‹œë„ ê´€ë¦¬.
    - **Cloud Sync**: ì™¸ë¶€ ì œì¡°ì‚¬ API(Smartcar ë“±)ì™€ì˜ ë°ì´í„° ë™ê¸°í™” ì‘ì—… ë¹„ë™ê¸°í™”.
    - **Heavy Reports**: ëŒ€ìš©ëŸ‰ ì‹œê³„ì—´ ë°ì´í„°ë¥¼ ê°€ê³µí•˜ëŠ” ë¦¬í¬íŠ¸ ìƒì„± ì‘ì—… ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬.

### 2.3 AI Systems (Integrated AI Services)
- **Role**: ë©€í‹°ëª¨ë‹¬ ë°ì´í„°(ì´ë¯¸ì§€, ìŒì„±, ì‹œê³„ì—´) ë¶„ì„ ë° ì§€ëŠ¥í˜• ê°€ì´ë“œ ìƒì„±.
- **Components**:
    - **AI Hub (Cloud GPU Service)**:
        - **Tech**: Python, FastAPI.
        - **Models**: YOLOv8-L (ì™¸ê´€), AST (ì—”ì§„ìŒ), LSTM-AE (OBD íŒ¨í„´) ì‹¤ì‹œê°„ ì¶”ë¡  ìˆ˜í–‰.
    - **openAI (Large Language Model)**:
        - **Model**: **GPT-4o**.
        - **Role**: AI Hubì˜ ë¶„ì„ ê²°ê³¼ì™€ OBD ë°ì´í„°ë¥¼ í•©ì„±í•˜ì—¬ ì‚¬ìš©ì ì¹œí™”ì ì¸ ì§„ë‹¨ ë¦¬í¬íŠ¸(`LLM Synthesis`) ìƒì„±.

### 2.4 PostgreSQL Integrated Instance (Data Persistence)
ë³¸ ì‹œìŠ¤í…œì€ **ë‹¨ì¼ PostgreSQL ì¸ìŠ¤í„´ìŠ¤**ì—ì„œ Extension ê¸°ëŠ¥ì„ í™œìš©í•˜ì—¬ ì„¸ ê°€ì§€ ë°ì´í„° ëª¨ë¸ì„ í†µí•© ê´€ë¦¬í•©ë‹ˆë‹¤.
- **ê´€ê³„í˜• í…Œì´ë¸” (Standard PostgreSQL)**:
    - ì‚¬ìš©ì ì •ë³´, ì°¨ëŸ‰ í”„ë¡œíŒŒì¼, ì§„ë‹¨ ì„¸ì…˜ ë° ìµœì¢… ë¦¬í¬íŠ¸ ë“± ì •í˜• ë°ì´í„° ì €ì¥.
- **ì‹œê³„ì—´ í…Œì´ë¸” (TimescaleDB Extension)**:
    - 1ì´ˆ ë‹¨ìœ„ë¡œ ìˆ˜ì§‘ë˜ëŠ” ëŒ€ëŸ‰ì˜ OBD í…”ë ˆë©”íŠ¸ë¦¬ ë°ì´í„°ë¥¼ í•˜ì´í¼í…Œì´ë¸”(Hypertables)ë¡œ ê´€ë¦¬. 7ì¼ ë³´ê´€ í›„ ìë™ ì‚­ì œ(Drop Chunk) ì •ì±… ì ìš©.
- **ë²¡í„° í…Œì´ë¸” (pgvector Extension)**:
    - ì°¨ëŸ‰ ì •ë¹„ ì§€ì‹ ë° ë§¤ë‰´ì–¼ì˜ ì„ë² ë”© ê°’ì„ ì €ì¥í•˜ì—¬ LLMì˜ RAG(ê²€ìƒ‰ ì¦ê°• ìƒì„±) ì†ŒìŠ¤ë¡œ í™œìš©.

### 2.5 Storage (Media Assets)
- **AWS S3 Bucket**:
    - **ëª©ì **: ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ ì‚¬ê³ /ê³ ì¥ ì‚¬ì§„, ë…¹í™”ëœ ì—”ì§„ ì†Œë¦¬ íŒŒì¼, AI ì¬í•™ìŠµìš© ì›ë³¸ ë¡œê·¸ ì €ì¥.

### 2.6 External Interfaces
- **Manufacturer API**: ì œì¡°ì‚¬ í´ë¼ìš°ë“œ(BlueLink/KiaConnect ë“±)ë¥¼ í†µí•œ ì°¨ëŸ‰ ìƒíƒœ ë°ì´í„° ë™ê¸°í™”.
- **Search API (Tavily)**: ìˆ˜ë¦¬ ë°©ë²• ë° ë¶€í’ˆ ê°€ê²© ì •ë³´ë¥¼ ìœ„í•œ ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰ ì—”ì§„ ì—°ë™.
- **Public Data Portal**: ì—”ì§„ ì˜¤ì¼ ê¶Œì¥ ì£¼ê¸°, ë¦¬ì½œ ì •ë³´ ë“± ê³µê³µ ì •ë³´ ì—°ë™.

---

## 3. í•µì‹¬ ë°ì´í„° íë¦„ ìƒì„¸ (Detailed Data Flow)

### 3.1 OBD-II ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì§‘ ë° ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸
ì°¨ëŸ‰ ì‹œë™ ON ì‹œì ë¶€í„° ì•±ì´ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì—¬ ì„œë²„ì— ì €ì¥í•˜ê³ , ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ë·°ë¥¼ ê°±ì‹ í•˜ëŠ” íë¦„ì…ë‹ˆë‹¤.

```mermaid
sequenceDiagram
    autonumber
    participant Car as ğŸš— Vehicle (ECU)
    participant OBD as ğŸ”Œ OBD Dongle
    participant App as ğŸ“± App (Client)
    participant API as ğŸš€ API Gateway
    participant TSDB as â±ï¸ TimescaleDB
    participant Redis as âš¡ Redis Cache (Latest)

    Note over Car, App: [Phase 1] Connection & Handshake
    App->>OBD: Connect via Bluetooth (RFCOMM)
    activate OBD
    OBD-->>App: Connected
    App->>OBD: Send AT Commands (Reset, Protocol Search)
    OBD->>Car: Identify Protocol (ISO 15765-4 CAN etc.)
    Car-->>OBD: Protocol OK
    OBD-->>App: Ready

    Note over Car, Redis: [Phase 2] Real-time Streaming (1Hz Loop)
    loop Every 1 Second
        App->>OBD: Request PIDs (010C RPM, 010D Speed, etc.)
        OBD->>Car: Get Live Data
        Car-->>OBD: hex Data (e.g., 41 0C 1A F8)
        OBD-->>App: Raw Hex Response
        
        App->>App: Parse Hex -> Decimal (RPM: 1720, Speed: 45)
        App->>App: Check Local Alerts (Safety Rules)
        
        par Display & Upload
            App->>App: Update Dashboard UI
            App->>API: POST /telemetry (Batch of 1-5 secs)
        end
    end

    Note over API, TSDB: [Phase 3] Ingestion & Storage
    API->>TSDB: INSERT raw telemetry (Hypertable)
    API->>Redis: SET vehicle:{id}:last_status (For fast polling)
    
    opt If Anomaly Detected by Backend Logic
        API->>App: FCM Push (Warning Alert)
    end
    deactivate OBD
```

### 3.2 AI ë©€í‹°ëª¨ë‹¬ ë³µí•© ì§„ë‹¨ í”„ë¡œì„¸ìŠ¤ (Link-based Diagnosis)
ì‚¬ìš©ìê°€ ì§„ë‹¨ì„ ìš”ì²­í–ˆì„ ë•Œ, ëŒ€ìš©ëŸ‰ íŒŒì¼ì€ S3ë¥¼ ê±°ì³ ì£¼ì†Œ ê¸°ë°˜ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.

```mermaid
sequenceDiagram
    autonumber
    actor User
    participant App
    participant API as ğŸš€ Main Backend (Java)
    participant S3 as â˜ï¸ AWS S3
    participant AI as ğŸ§  AI Service (FastAPI)
    participant DB as ğŸ˜ PostgreSQL

    User->>App: "ì§„ë‹¨ ìš”ì²­" (ì‚¬ì§„/ìŒì„± + OBD ë°ì´í„°)
    App->>API: POST /diagnosis (Multipart File + JSON)
    
    Note over API, S3: [Step 1] Evidence Persistence
    API->>S3: ì›ë³¸ íŒŒì¼ ì €ì¥ (Upload)
    S3-->>API: S3_URL ë°˜í™˜
    
    Note over API, AI: [Step 2] Metadata Analysis
    API->>AI: ë¶„ì„ ìš”ì²­ (S3_URL + OBD Context)
    
    rect rgb(240, 248, 255)
        Note over AI: AI ë¶„ì„ ì¤‘
        AI->>S3: íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë° ì¸í¼ëŸ°ìŠ¤
        AI-->>API: ë¶„ì„ ê²°ê³¼ JSON ë°˜í™˜ (ì´ìŠˆ íƒì§€ ê²°ê³¼ ë“±)
    end
    
    Note over API, DB: [Step 3] Final Synthesis
    API->>API: LLM ë³´ê³ ì„œ í•©ì„± (AI ê²°ê³¼ + OBD + RAG)
    API->>DB: ì§„ë‹¨ ì„¸ì…˜ ë° ê²°ê³¼ ì €ì¥
    
    API-->>App: ì§„ë‹¨ ê²°ê³¼ (JSON) ë°˜í™˜
    App->>App: ì‚¬ìš©ì ê²°ê³¼ í™”ë©´ í‘œì‹œ
```

### 3.3 ì œì¡°ì‚¬ í´ë¼ìš°ë“œ ì—°ë™ (OAuth 2.0 Flow)
ì‚¬ìš©ìê°€ ì œì¡°ì‚¬ ê³„ì •ì„ ì—°ê²°í•˜ê³  ë°ì´í„°ë¥¼ ë™ê¸°í™”í•˜ëŠ” ë³´ì•ˆ íë¦„ì…ë‹ˆë‹¤.

```mermaid
sequenceDiagram
    autonumber
    actor User
    participant App
    participant API as ğŸš€ Main Backend
    participant Auth as ğŸ›ï¸ Manufacturer Auth
    participant DB as ğŸ˜ PostgreSQL (cloud_accounts)

    User->>App: "ì œì¡°ì‚¬ ê³„ì • ì—°ê²°" ì„ íƒ
    App->>API: GET /cloud/connect (Provider ì„ íƒ)
    API-->>App: Auth URL ë°˜í™˜ (Client ID, Scope í¬í•¨)
    
    App->>Auth: ì›¹ë·°ì—ì„œ ì œì¡°ì‚¬ ë¡œê·¸ì¸/ë™ì˜
    Auth-->>App: Authorization Code ì „ë‹¬
    
    App->>API: POST /cloud/callback (Code ì „ë‹¬)
    
    API->>Auth: Token Exchange (Code <-> Tokens)
    Auth-->>API: Access Token & Refresh Token ë°˜í™˜
    
    Note over API, DB: [Security] AES-256 Encryption
    API->>API: í† í° ì•”í˜¸í™” ì²˜ë¦¬
    API->>DB: encrypted_tokens ì €ì¥
    
    API-->>App: ì—°ë™ ì™„ë£Œ ì•Œë¦¼
```

### 3.4 ì†Œëª¨í’ˆ ì˜ˆì§€ ì •ë¹„ ë° ë°°ì¹˜ ë¶„ì„ (Predictive Maintenance Batch)
ë§¤ì¼ ë°¤ ìˆ˜í–‰ë˜ëŠ” ëŒ€ê·œëª¨ ë°ì´í„° ë¶„ì„ ë° ì˜ˆì¸¡ íŒŒì´í”„ë¼ì¸ì…ë‹ˆë‹¤.

```mermaid
flowchart TD
    trigger((â° Daily Trigger<br/>03:00 AM)) --> BatchJob[batch-prediction-job]
    
    subgraph Data_Preparation
        BatchJob --> FetchData[Fetch Last 30 Days Summary from Postgres]
        BatchJob --> FetchRaw[Fetch Last 7 Days Raw Waveform from TimescaleDB]
        FetchData & FetchRaw --> Preprocess[Feature Engineering<br/>(Trend, Drift, Volatility)]
    end
    
    subgraph AI_Inference
        Preprocess --> XGBoost[XGBoost Regressor<br/>(Consumables Life %)]
        Preprocess --> LSTM[LSTM Anomaly Detector<br/>(Battery/Start-up Voltage)]
    end
    
    subgraph Evaluation_Action
        XGBoost --> CheckLife{Life < 10%?}
        LSTM --> CheckDanger{Failure Prob > 80%?}
        
        CheckLife -- Yes --> CreateNoti1[Create Notification<br/>'Engine Oil Change Due']
        CheckLife -- No --> UpdateStatus1[Update Current Status DB]
        
        CheckDanger -- Yes --> CreateNoti2[Create **CRITICAL** Alert<br/>'Battery Dying Soon']
        CheckDanger -- No --> UpdateStatus2[Log Prediction Score]
    end
    
    CreateNoti1 & CreateNoti2 --> PushServer[FCM Push Server]
    UpdateStatus1 & UpdateStatus2 --> DB[(PostgreSQL)]

```

---

## 4. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì„¤ê³„ (Extended ERD)

ê¸°ë³¸ì ì¸ ì‚¬ìš©ì/ì°¨ëŸ‰ ì •ë³´ ì™¸ì—, **ì‹œê³„ì—´ ë°ì´í„° ìµœì í™”**ì™€ **AI ì§„ë‹¨ ì´ë ¥** ê´€ë¦¬ì— ì´ˆì ì„ ë§ì¶˜ í™•ì¥ ì„¤ê³„ì…ë‹ˆë‹¤.

### 4.1 ê°„ëµ ERD (Simplified ERD)

> [!NOTE]
> ë³¸ ë‹¤ì´ì–´ê·¸ë¨ì€ ì‹œìŠ¤í…œì˜ ì „ì²´ì ì¸ ê´€ê³„ë¥¼ íŒŒì•…í•˜ê¸° ìœ„í•œ **ê°„ëµ ë²„ì „**ì…ë‹ˆë‹¤. ê° ì»¬ëŸ¼ì˜ ë°ì´í„° íƒ€ì…, ì œì•½ ì¡°ê±´, Enum ê°’ ë“± ìƒì„¸í•œ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ ì •ë³´ëŠ” [ë°ì´í„°ë² ì´ìŠ¤ ìƒì„¸ ì„¤ê³„ì„œ (DB_ì„¤ê³„ì„œ.md)](file:///c:/dev/AI/AI-5-main/Docs/DB_ì„¤ê³„ì„œ.md)ë¥¼ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤.

![ê°„ëµ ERD](file:///c:/dev/AI/AI-5-main/Docs/erd_detailed.png)

---

## 5. ë³´ì•ˆ ë° ë„¤íŠ¸ì›Œí¬ ì„¤ê³„ (Security & Network)

### 5.1 ë„¤íŠ¸ì›Œí¬ ì•„í‚¤í…ì²˜
- **Private Subnet ì›ì¹™**: DB(PostgreSQL, TimescaleDB, Redis)ì™€ AI Inference ServerëŠ” ì™¸ë¶€ì—ì„œ ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ì—†ëŠ” Private Subnetì— ë°°ì¹˜.
- **Bastion Host / VPN**: ê´€ë¦¬ì ì „ìš© ì ‘ê·¼ í†µë¡œ.
- **TLS 1.3**: ëª¨ë“  êµ¬ê°„(App-Server, Server-DB)ì— ì•”í˜¸í™” í†µì‹  ì ìš©.

### 5.2 ë°ì´í„° ë³´ì•ˆ
- **VIN & PII ì•”í˜¸í™”**: `AES-256-GCM` ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì—¬ DB ì €ì¥ ì‹œ ì•”í˜¸í™”. (Key Management System í™œìš© ê¶Œì¥).
- **ë°ì´í„° ë¹„ì‹ë³„í™”**: AI í•™ìŠµìš©ìœ¼ë¡œ S3ë¡œ ì´ê´€ë˜ëŠ” ë°ì´í„°ëŠ” `user_id`, `vin` ë“±ì„ ì œê±°í•˜ê±°ë‚˜ Hashing ì²˜ë¦¬í•˜ì—¬ ì €ì¥.

---
**[ë¬¸ì„œ ë]**
